<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="/static/styles/checkout.css" />
    <title>DEMB√âL√â TELECOM - WiFi Premium</title>
  </head>
  <body>
    <div class="container">
      <div class="logo-wrap">
        <div class="logo-ripple"></div>
        <img src="/static/logo.png" alt="Logo" class="logo-img" />
      </div>

      <!-- <div id="manual-section" class="manual-login">
        <div
          style="
            font-size: 0.7rem;
            color: var(--primary);
            margin-bottom: 10px;
            font-weight: bold;
          "
        >
          TICKET PHYSIQUE
        </div>
        <input type="text" id="manual_code" placeholder="Code ticket" />
        <button
          style="
            margin-top: 10px;
            background: var(--primary);
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
          "
          onclick="alert('V√©rification...')"
        >
          VALIDER LE TICKET
        </button>
      </div> -->

      <div id="divider-line" class="divider">
        <span>OU ACHETER EN LIGNE</span>
      </div>

      <div id="plans-list">
        {% for category in categories %}
        <div
          class="plan-card {% if category.stock_restant == 0 %}plan-card-disabled{% endif %}"
          {%
          if
          category.stock_restant
        >
          0 %}onclick="openPay('{{category.price}}', '{{category.id}}')"{% endif
          %} data-category-id="{{category.id}}" >
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              width: 100%;
            "
          >
            <span style="font-weight: 600"
              >‚è±Ô∏è {{category.activity_time}}
              {{category.activity_time_unit}}</span
            >
            <span class="plan-price">{{category.price}}</span>
          </div>
          <span
            class="stock-info"
            style="font-size: 0.7rem; color: {% if category.stock_restant > 0 %}#4CAF50{% else %}#f44336{% endif %}; margin-top: 5px; display: block;"
          >
            {% if category.stock_restant > 0 %} {{category.stock_restant}}
            ticket{% if category.stock_restant > 1 %}s{% endif %} disponible{%
            if category.stock_restant > 1 %}s{% endif %} {% else %} √âpuis√© {%
            endif %}
          </span>
        </div>
        {% endfor %}
      </div>

      <div id="payment-area" style="display: none">
        <b style="color: #ff6600">PAIEMENT ORANGE MONEY</b>
        <div id="marketing-box" style="margin-top: 10px">
          <input
            type="text"
            id="client_name"
            placeholder="Votre Nom complet"
            required
          />
          <input
            type="tel"
            id="client_phone"
            placeholder="Votre n¬∞ Whatsapp"
            required
          />
        </div>
        <p style="font-size: 0.9rem; margin: 15px 0">
          Envoyez <b id="target-price">...</b> au <b>79 53 15 43</b>
        </p>
        <textarea
          id="sms_box"
          placeholder="Collez le SMS de confirmation Orange Money ici..."
        ></textarea>
        <button
          class="call-button"
          style="position: static; font-size: 1rem"
          onclick="activerService()"
        >
          ENVOYER MA DEMANDE
        </button>
        <button
          onclick="closePay()"
          style="
            width: 100%;
            background: none;
            border: none;
            color: #999;
            margin-top: 15px;
            cursor: pointer;
          "
        >
          ‚¨Ö RETOUR
        </button>
      </div>

      <div id="waiting-area" style="display: none">
        <div style="text-align: center">
          <div class="spinner"></div>
          <b style="color: var(--secondary); font-size: 1.2rem"
            >DEMANDE EN COURS...</b
          >
          <p style="font-size: 0.9rem; color: #333; margin-top: 15px">
            Votre demande est bien re√ßue. L'administrateur va valider votre
            acc√®s d'ici peu.
          </p>

          <div class="urgent-box">
            <b style="color: var(--urgent-red); font-size: 0.85rem"
              >‚ö° BESOIN D'UNE ACTIVATION RAPIDE ?</b
            >
            <p style="font-size: 0.75rem; color: #555; margin-top: 5px">
              Si c'est urgent ou s'il est tard, cliquez ci-dessous pour me
              signaler votre demande.
            </p>
            <a href="tel:+22377426001" class="btn-urgent"
              >üìû APPELER POUR SIGNALER</a
            >
          </div>

          <div
            style="
              background: #e6f7ff;
              border: 1px solid #91d5ff;
              padding: 12px;
              border-radius: 12px;
              margin-top: 15px;
            "
          >
            <p style="font-size: 0.8rem; color: #0050b3; margin: 0">
              <b>Note :</b> Vous pouvez fermer cette page et vaquer √† vos
              occupations. Vous recevrez votre code ticket une fois valid√©.
            </p>
          </div>
        </div>
      </div>
    </div>

    <a href="tel:79531543" class="call-anchor">
      <div class="call-button">üìû BESOIN D'AIDE ? APPELEZ-MOI</div>
    </a>

    <script>
      let selectedCategoryId = null;

      // Charger les donn√©es du localStorage
      function loadStoredData() {
        const storedName = localStorage.getItem("client_name");
        const storedPhone = localStorage.getItem("client_phone");

        if (storedName) {
          document.getElementById("client_name").value = storedName;
        }
        if (storedPhone) {
          document.getElementById("client_phone").value = storedPhone;
        }
      }

      // Sauvegarder les donn√©es dans le localStorage
      function saveStoredData() {
        const clientName = document.getElementById("client_name").value.trim();
        const clientPhone = document
          .getElementById("client_phone")
          .value.trim();

        if (clientName) {
          localStorage.setItem("client_name", clientName);
        }
        if (clientPhone) {
          localStorage.setItem("client_phone", clientPhone);
        }
      }

      // Charger les donn√©es au chargement de la page
      document.addEventListener("DOMContentLoaded", loadStoredData);

      function openPay(price, categoryId) {
        selectedCategoryId = categoryId;
        console.log("Selected Category ID:", selectedCategoryId);
        document.getElementById("plans-list").style.display = "none";
        if (Number(selectedCategoryId) <= 3) {
          document.getElementById("marketing-box").style.display = "none";
        }
        document.getElementById("divider-line").style.display = "none";
        document.getElementById("target-price").innerText = price;
        document.getElementById("payment-area").style.display = "block";
      }

      function closePay() {
        document.getElementById("payment-area").style.display = "none";
        document.getElementById("plans-list").style.display = "block";
        document.getElementById("divider-line").style.display = "block";
        selectedCategoryId = null;
      }

      // Sauvegarder les donn√©es lors de la saisie
      document
        .getElementById("client_name")
        ?.addEventListener("input", saveStoredData);
      document
        .getElementById("client_phone")
        ?.addEventListener("input", saveStoredData);

      async function activerService() {
        const clientName = document.getElementById("client_name").value.trim();
        const clientPhone = document
          .getElementById("client_phone")
          .value.trim();
        const sms = document.getElementById("sms_box").value.trim();

        if (!clientName) {
          alert("Veuillez entrer votre nom complet.");
          return;
        }

        if (!clientPhone) {
          alert("Veuillez entrer votre num√©ro de t√©l√©phone.");
          return;
        }

        if (!sms) {
          alert("Veuillez coller le SMS de confirmation Orange Money.");
          return;
        }

        if (!selectedCategoryId) {
          alert("Erreur: Cat√©gorie non s√©lectionn√©e.");
          return;
        }

        // Sauvegarder les donn√©es avant l'envoi
        saveStoredData();

        document.getElementById("payment-area").style.display = "none";
        document.getElementById("waiting-area").style.display = "block";

        try {
          const response = await fetch("/api/create-ticket-request", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              category_id: selectedCategoryId,
              client_name: clientName,
              client_phone: clientPhone,
              sms_content: sms,
            }),
          });

          const data = await response.json();

          if (data.status === "ok") {
            // Rediriger vers la page de statut
            setTimeout(() => {
              window.location.href = `/request/${data.request_id}`;
            }, 2000);
          } else {
            alert("Erreur: " + (data.message || "Une erreur est survenue"));
            document.getElementById("waiting-area").style.display = "none";
            document.getElementById("payment-area").style.display = "block";
          }
        } catch (error) {
          console.error("Erreur:", error);
          alert("Une erreur est survenue. Veuillez r√©essayer.");
          document.getElementById("waiting-area").style.display = "none";
          document.getElementById("payment-area").style.display = "block";
        }
      }
    </script>
  </body>
</html>
